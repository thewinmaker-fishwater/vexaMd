name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create.outputs.id }}
      release_upload_url: ${{ steps.create.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: 'Vexa MD ${{ github.ref_name }}'
          body: |
            ## Vexa MD ${{ github.ref_name }}

            ### Downloads
            - **Windows**: `.exe` installer (NSIS)
            - **macOS**: `.dmg` (ARM64 for M1/M2, Intel for older Macs)
            - **Linux**: `.deb` or `.AppImage`
          draft: true
          prerelease: false

  build:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            name: 'macOS-ARM64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            name: 'macOS-Intel'
          - platform: 'ubuntu-22.04'
            args: ''
            name: 'Linux'
          - platform: 'windows-latest'
            args: ''
            name: 'Windows'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- ${{ matrix.args }}

      - name: Upload artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.exe.sig

      - name: Upload artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            src-tauri/target/*/release/bundle/dmg/*.dmg
            src-tauri/target/*/release/bundle/macos/*.tar.gz
            src-tauri/target/*/release/bundle/macos/*.tar.gz.sig

      - name: Upload artifacts (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/*.AppImage.sig

  update-json:
    needs: [create-release, build]
    if: always() && needs.create-release.result == 'success'
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate latest.json for updater
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"

          # Get asset names from release (draft releases need ID-based access)
          ASSET_NAMES=$(gh api repos/${REPO}/releases/${RELEASE_ID} --jq '.assets[].name')

          echo "=== Release assets ==="
          echo "$ASSET_NAMES"

          # Helper: download sig content from draft release asset via API
          download_sig() {
            local sig_name="$1"
            gh api repos/${REPO}/releases/${RELEASE_ID} \
              --jq ".assets[] | select(.name == \"${sig_name}\") | .url" \
            | xargs -I{} curl -sL -H "Accept: application/octet-stream" \
              -H "Authorization: token ${GITHUB_TOKEN}" "{}"
          }

          # Find platform-specific updater artifacts by name, construct tag-based URLs
          WIN_SIG=""
          WIN_URL=""
          LINUX_SIG=""
          LINUX_URL=""
          MAC_AARCH64_SIG=""
          MAC_AARCH64_URL=""
          MAC_X64_SIG=""
          MAC_X64_URL=""

          # Windows: .exe installer
          WIN_NAME=$(echo "$ASSET_NAMES" | grep -E '\-setup\.exe$' | head -1)
          WIN_SIG_NAME=$(echo "$ASSET_NAMES" | grep -E '\-setup\.exe\.sig$' | head -1)
          if [ -n "$WIN_NAME" ]; then
            WIN_URL="${BASE_URL}/${WIN_NAME}"
            if [ -n "$WIN_SIG_NAME" ]; then
              WIN_SIG=$(download_sig "$WIN_SIG_NAME")
            fi
          fi

          # Linux: .AppImage
          LINUX_NAME=$(echo "$ASSET_NAMES" | grep -E '\.AppImage$' | head -1)
          LINUX_SIG_NAME=$(echo "$ASSET_NAMES" | grep -E '\.AppImage\.sig$' | head -1)
          if [ -n "$LINUX_NAME" ]; then
            LINUX_URL="${BASE_URL}/${LINUX_NAME}"
            if [ -n "$LINUX_SIG_NAME" ]; then
              LINUX_SIG=$(download_sig "$LINUX_SIG_NAME")
            fi
          fi

          # macOS: .app.tar.gz (may have aarch64 and x86_64 variants)
          MAC_AARCH64_NAME=$(echo "$ASSET_NAMES" | grep -E 'aarch64.*\.app\.tar\.gz$' | head -1)
          MAC_AARCH64_SIG_NAME=$(echo "$ASSET_NAMES" | grep -E 'aarch64.*\.app\.tar\.gz\.sig$' | head -1)
          MAC_X64_NAME=$(echo "$ASSET_NAMES" | grep -E 'x64.*\.app\.tar\.gz$' | head -1)
          MAC_X64_SIG_NAME=$(echo "$ASSET_NAMES" | grep -E 'x64.*\.app\.tar\.gz\.sig$' | head -1)

          # Fallback: if no arch-specific names, use generic .app.tar.gz for both
          if [ -z "$MAC_AARCH64_NAME" ] && [ -z "$MAC_X64_NAME" ]; then
            MAC_GENERIC_NAME=$(echo "$ASSET_NAMES" | grep -E '\.app\.tar\.gz$' | head -1)
            MAC_GENERIC_SIG_NAME=$(echo "$ASSET_NAMES" | grep -E '\.app\.tar\.gz\.sig$' | head -1)
            MAC_AARCH64_NAME="$MAC_GENERIC_NAME"
            MAC_AARCH64_SIG_NAME="$MAC_GENERIC_SIG_NAME"
            MAC_X64_NAME="$MAC_GENERIC_NAME"
            MAC_X64_SIG_NAME="$MAC_GENERIC_SIG_NAME"
          fi

          if [ -n "$MAC_AARCH64_NAME" ]; then
            MAC_AARCH64_URL="${BASE_URL}/${MAC_AARCH64_NAME}"
            if [ -n "$MAC_AARCH64_SIG_NAME" ]; then
              MAC_AARCH64_SIG=$(download_sig "$MAC_AARCH64_SIG_NAME")
            fi
          fi
          if [ -n "$MAC_X64_NAME" ]; then
            MAC_X64_URL="${BASE_URL}/${MAC_X64_NAME}"
            if [ -n "$MAC_X64_SIG_NAME" ]; then
              MAC_X64_SIG=$(download_sig "$MAC_X64_SIG_NAME")
            fi
          fi

          # Build latest.json
          PLATFORMS="{}"
          if [ -n "$WIN_URL" ]; then
            PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "$WIN_URL" --arg sig "$WIN_SIG" '. + {"windows-x86_64": {url: $url, signature: $sig}}')
          fi
          if [ -n "$LINUX_URL" ]; then
            PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "$LINUX_URL" --arg sig "$LINUX_SIG" '. + {"linux-x86_64": {url: $url, signature: $sig}}')
          fi
          if [ -n "$MAC_AARCH64_URL" ]; then
            PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "$MAC_AARCH64_URL" --arg sig "$MAC_AARCH64_SIG" '. + {"darwin-aarch64": {url: $url, signature: $sig}}')
          fi
          if [ -n "$MAC_X64_URL" ]; then
            PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "$MAC_X64_URL" --arg sig "$MAC_X64_SIG" '. + {"darwin-x86_64": {url: $url, signature: $sig}}')
          fi

          jq -n \
            --arg version "$VERSION" \
            --arg pub_date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, pub_date: $pub_date, platforms: $platforms}' > latest.json

          echo "=== latest.json ==="
          cat latest.json

          # Upload latest.json to release
          gh release upload "$TAG" latest.json --repo "$REPO" --clobber
