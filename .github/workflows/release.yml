name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create.outputs.id }}
      release_upload_url: ${{ steps.create.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: 'Vexa MD ${{ github.ref_name }}'
          body: |
            ## Vexa MD ${{ github.ref_name }}

            ### Downloads
            - **Windows**: `.exe` installer (NSIS)
            - **macOS**: `.dmg` (ARM64 for M1/M2, Intel for older Macs)
            - **Linux**: `.deb` or `.AppImage`
          draft: true
          prerelease: false

  build:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            name: 'macOS-ARM64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            name: 'macOS-Intel'
          - platform: 'ubuntu-22.04'
            args: ''
            name: 'Linux'
          - platform: 'windows-latest'
            args: ''
            name: 'Windows'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build ${{ matrix.args }}

      - name: Upload artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.exe.sig
            src-tauri/target/release/bundle/nsis/*.nsis.zip
            src-tauri/target/release/bundle/nsis/*.nsis.zip.sig

      - name: Upload artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            src-tauri/target/*/release/bundle/dmg/*.dmg
            src-tauri/target/*/release/bundle/macos/*.tar.gz
            src-tauri/target/*/release/bundle/macos/*.tar.gz.sig

      - name: Upload artifacts (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz
            src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz.sig

  update-json:
    needs: [create-release, build]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate latest.json for updater
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          REPO="${{ github.repository }}"

          # Get release assets
          ASSETS=$(gh api repos/${REPO}/releases/tags/${TAG} --jq '.assets[] | {name, url: .browser_download_url}')

          # Find platform-specific updater artifacts
          WIN_SIG=""
          WIN_URL=""
          LINUX_SIG=""
          LINUX_URL=""
          MAC_ARM_SIG=""
          MAC_ARM_URL=""
          MAC_INTEL_SIG=""
          MAC_INTEL_URL=""

          # Windows NSIS
          WIN_URL=$(echo "$ASSETS" | jq -r 'select(.name | endswith(".nsis.zip")) | .url' | head -1)
          WIN_SIG_FILE=$(echo "$ASSETS" | jq -r 'select(.name | endswith(".nsis.zip.sig")) | .url' | head -1)
          if [ -n "$WIN_SIG_FILE" ]; then
            WIN_SIG=$(curl -sL "$WIN_SIG_FILE")
          fi

          # Linux AppImage
          LINUX_URL=$(echo "$ASSETS" | jq -r 'select(.name | endswith(".AppImage.tar.gz")) | .url' | head -1)
          LINUX_SIG_FILE=$(echo "$ASSETS" | jq -r 'select(.name | endswith(".AppImage.tar.gz.sig")) | .url' | head -1)
          if [ -n "$LINUX_SIG_FILE" ]; then
            LINUX_SIG=$(curl -sL "$LINUX_SIG_FILE")
          fi

          # macOS ARM64
          MAC_ARM_URL=$(echo "$ASSETS" | jq -r 'select(.name | contains("aarch64") and endswith(".tar.gz") and (endswith(".sig") | not)) | .url' | head -1)
          MAC_ARM_SIG_FILE=$(echo "$ASSETS" | jq -r 'select(.name | contains("aarch64") and endswith(".tar.gz.sig")) | .url' | head -1)
          if [ -n "$MAC_ARM_SIG_FILE" ]; then
            MAC_ARM_SIG=$(curl -sL "$MAC_ARM_SIG_FILE")
          fi

          # macOS Intel
          MAC_INTEL_URL=$(echo "$ASSETS" | jq -r 'select(.name | contains("x86_64") and endswith(".tar.gz") and (endswith(".sig") | not)) | .url' | head -1)
          MAC_INTEL_SIG_FILE=$(echo "$ASSETS" | jq -r 'select(.name | contains("x86_64") and endswith(".tar.gz.sig")) | .url' | head -1)
          if [ -n "$MAC_INTEL_SIG_FILE" ]; then
            MAC_INTEL_SIG=$(curl -sL "$MAC_INTEL_SIG_FILE")
          fi

          # Build latest.json
          PLATFORMS="{}"
          if [ -n "$WIN_URL" ]; then
            PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "$WIN_URL" --arg sig "$WIN_SIG" '. + {"windows-x86_64": {url: $url, signature: $sig}}')
          fi
          if [ -n "$LINUX_URL" ]; then
            PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "$LINUX_URL" --arg sig "$LINUX_SIG" '. + {"linux-x86_64": {url: $url, signature: $sig}}')
          fi
          if [ -n "$MAC_ARM_URL" ]; then
            PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "$MAC_ARM_URL" --arg sig "$MAC_ARM_SIG" '. + {"darwin-aarch64": {url: $url, signature: $sig}}')
          fi
          if [ -n "$MAC_INTEL_URL" ]; then
            PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "$MAC_INTEL_URL" --arg sig "$MAC_INTEL_SIG" '. + {"darwin-x86_64": {url: $url, signature: $sig}}')
          fi

          jq -n \
            --arg version "$VERSION" \
            --arg pub_date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, pub_date: $pub_date, platforms: $platforms}' > latest.json

          cat latest.json

          # Upload latest.json to release
          gh release upload "$TAG" latest.json --repo "$REPO" --clobber
